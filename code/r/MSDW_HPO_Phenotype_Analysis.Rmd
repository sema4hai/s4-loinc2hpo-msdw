---
title: "LOINC2HPO_EPIC AND SCC"
output:
  html_document:
    df_print: paged
---

## GOAL
This is to LOINC2HPO analysis of both EPIC and SCC labs. 
```{r message=FALSE}
library(tidyverse)
library(glue)
library(readxl)
require(DBI)
require(RPostgres)
require(egg)
require(gridExtra)
source('.db_credential.R')
dsca <- DBI::dbConnect(RPostgres::Postgres(), host='localhost', user=user, dbname = dbname, port = 2345, password=password)
```


## ANALYSIS

```{r}
CACHE_DIR = 'cache'
if (!dir.exists(CACHE_DIR)){
  dir.create(CACHE_DIR)
}

get_db_data <- function(sql, df_path, force_rerun=FALSE, cache_dir=CACHE_DIR){
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, sql)
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

FORCE_RERUN <- FALSE
```


### Identify starting cohort
The starting cohort could be the entirety of the MSDW set, but here we focus on the subcohort where we have lab data for. 
```{sql connection=dsca}
create temp table cohort as 
select distinct medical_record_number 
from hai_az_prod.lab_scc_2020july lsj 
union 
select distinct mrn as medical_record_number 
from hai_az_test.lab_epic_2020july lej ;
```


### Collect patient basic demographics
```{r}
get_patient_race_sex_distribution <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/patient_count_by_race_sex.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
            select race, gender, count(*) as n
            from hai_az_prod.person_msdw_2020july pmj 
            join cohort using (medical_record_number)
            group by race, gender 
            order by race, gender;
            ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
  
}

patient_race_sex_distribution <- get_patient_race_sex_distribution(force_rerun = FALSE)


# recode all unknown gender as one category
patient_race_sex_distribution <- patient_race_sex_distribution %>%
  mutate(gender = recode(gender, 'MSDW_NOT APPL' = 'Unknown')) %>%
  mutate(gender = recode(gender, 'MSDW_OTHER' = 'Unknown')) %>%
  mutate(gender = recode(gender, 'MSDW_UNKNOWN' = 'Unknown')) %>%
  mutate(gender = recode(gender, 'NOT AVAILABLE'= 'Unknown')) %>%
  mutate(gender = recode(gender, .missing = 'Unknown'))

# the following cleaning are no longer needed after updating the race mapping file
# recode "African American" as "Black or African American"
# patient_race_sex_distribution <- patient_race_sex_distribution %>%
#   mutate(race = recode(race, 'African American' = 'Black or African American'))
```

```{r}
countByGender <- patient_race_sex_distribution %>% 
  group_by(gender) %>% 
  summarise(n = sum(n))

plot_by_sex <- ggplot(countByGender) + 
  geom_bar(aes(x = 1, y = n / sum(n), fill = gender), stat = "identity") + 
  scale_fill_manual(name = "Sex", values = c(Male = "royalblue", Female = "lightcoral", Indeterminant = 'Cyan', Unknown = 'Orange')) + 
  xlab("") + ylab("patient count") +
  coord_polar(theta = "y") + 
  theme_bw() + 
  theme(panel.grid = element_blank(), legend.position = c(0.25, 0.7), 
        axis.text = element_blank(), axis.ticks = element_blank(), 
        axis.title = element_text(size = 8), legend.text = element_text(size = 8), 
        legend.title = element_text(size = 10), 
        legend.background = element_rect(fill=alpha('white', 0.1)))

ggsave(filename = glue('{CACHE_DIR}/plot_by_sex.png'), plot = plot_by_sex, width = 2.5, height = 2.5)
plot_by_sex
```


```{r}
countByRace_Gender <- patient_race_sex_distribution

countByRace_Gender$race <- if_else(countByRace_Gender$race == 'Unknown', 'Unreported', countByRace_Gender$race)

plot_by_race  <- ggplot(countByRace_Gender %>% 
         filter(gender %in% c('Male', 'Female')) %>% 
         mutate(race = as.factor(race), n = if_else(gender == "Male", n, -n))) + 
  geom_bar(aes(x = reorder(race, -n, FUN=sum), y = n, fill = gender, group=gender), stat="identity") + 
##  scale_y_continuous(breaks = seq(-40,40, 10), labels = abs(seq(-40,40, 10))) +
  scale_fill_manual(name = "Sex", values = c(Male = "royalblue", Female = "lightcoral")) + 
  scale_y_continuous(labels = abs) +
  xlab("") + ylab("patient count") +
  coord_flip() + 
  theme_bw() + 
  theme(panel.grid = element_blank(), legend.position = "right", 
        axis.title = element_text(size = 8), axis.text = element_text(size = 8), 
        legend.text = element_text(size = 8), legend.title = element_text(size = 10), 
        legend.background = element_rect(fill=alpha('white', 0.1)))

ggsave(filename = glue("{CACHE_DIR}/plotByRace.png"), plot = plot_by_race, width = 5, height = 2)
plot_by_race
```

Patient age analysis: find the birth years for all the patients and find their current age
```{r}
get_patient_birth_year_distribution <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/patient_count_by_birth_year_sex.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
            with person_birth_year as (
            	select medical_record_number , date_of_birth , gender , date_part('Year', date_of_birth) as birth_year 
            	from hai_az_prod.person_msdw_2020july pmj
            )
            select birth_year, gender, count(*) as n 
            from person_birth_year 
            join cohort using (medical_record_number)
            group by birth_year , gender 
            order by birth_year, gender;
            ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
  
}

patient_birth_year_sex_distribution <- get_patient_birth_year_distribution(FALSE)

# lump together sex that can be treated as Unknown
patient_birth_year_sex_distribution <- patient_birth_year_sex_distribution %>% 
  mutate(gender = recode(gender, 'MSDW_NOT APPL' = 'Unknown')) %>%
  mutate(gender = recode(gender, 'MSDW_OTHER' = 'Unknown')) %>%
  mutate(gender = recode(gender, 'MSDW_UNKNOWN' = 'Unknown')) %>%
  mutate(gender = recode(gender, 'NOT AVAILABLE'= 'Unknown')) %>%
  mutate(gender = recode(gender, .missing = 'Unknown')) %>%
  # sample_n(50) %>%
  # ignore ~ 1 million patients whoes birth_year is unknown
  # filter(!is.na(birth_year)) %>%
  # 2 patients have birth_year after 2020, which is clearly error as our database cut off is 2020
  filter(birth_year <= 2020) %>%
  mutate(birth_year_bucket = cut(birth_year, breaks = c(1800, seq(1931, 2021, by = 10)), dig.lab = 4)) %>%
  group_by(birth_year_bucket, gender) %>% 
  summarise(n = sum(n), .groups = 'drop') %>% 
  arrange(birth_year_bucket)


plot_by_birth_year_sex <- patient_birth_year_sex_distribution %>% ungroup() %>% 
  filter(gender %in% c('Male', 'Female')) %>% 
  mutate(n = if_else(gender == 'Female', -n, n)) %>%
  mutate(birth_year_bucket = factor(birth_year_bucket, levels = rev(levels(birth_year_bucket)))) %>% 
  # change bucket name (1800,1931] to '<= 1931'
  # change bucket name (2011, 2021] to '(2011, 2020]' -- our database cutoff is 2020
  mutate(birth_year_bucket = recode(birth_year_bucket, '(1800,1931]' = '<=1931')) %>% 
  mutate(birth_year_bucket = recode(birth_year_bucket, '(2011,2021]' = '(2011,2020]')) %>%{
    ggplot(.) +
  geom_bar(aes(x = birth_year_bucket, y = n, fill = gender), stat = 'identity') + 
  scale_fill_manual(name = "Sex", values = c(Male = "royalblue", Female = "lightcoral")) + 
  scale_y_continuous(labels = abs) +
  xlab('') + ylab('patient count') +
  coord_flip() + 
      theme_bw() + 
  theme(panel.grid = element_blank(), legend.position = "right", 
        axis.title = element_text(size = 8), axis.text = element_text(size = 8), 
        legend.text = element_text(size = 8), legend.title = element_text(size = 10), 
        legend.background = element_rect(fill=alpha('white', 0.1)))
  }
  

ggsave(filename = glue("{CACHE_DIR}/plotByBirthyearSex.png"), plot = plot_by_birth_year_sex, width = 4, height = 3)
plot_by_birth_year_sex
  
```

### Success rate of LOINC2HPO
```{r}
# among all the labs, what is the percentage that can be mapped to HPO
get_loinc2hpo_success_metric <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/loinc2hpo_success_metric.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
            with scc_lab_count as (
            	select context_name , count(*) as n_test
            	from hai_az_prod.lab_scc_2020july lsj 
            	join hai_az_prod.fd_procedure fp using (procedure_key)
            	group by context_name
            ),
            epic_lab as (
            	select distinct mrn, order_date, lab_time , test_code, test_result_value  from prod_msdw.epic_lab el
            ),
            epic_lab_count as (
            	select 'EPIC' as context_name, count(*) as n_test from epic_lab
            ),
            lab_count as (
            	select * from scc_lab_count 
            	union all 
            	select * from epic_lab_count 
            ),
            loinc_success_count as (
            	select context_name , count(*) as n_loinc_success
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july saelalhj 
            	where loinc is not null
            	group by context_name
            ),
            loinc2hpo_success_count as (
            	select context_name , count(*) as n_loinc2hpo_success
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july saelalhj 
            	where hpotermid is not null
            	group by context_name 
            )
            select *, (n_loinc_success + 0.1)/n_test as loinc_success_rate, (n_loinc2hpo_success + 0.1)/n_test as loinc2hpo_success_rate
            from lab_count
            left join loinc_success_count using (context_name)
            left join loinc2hpo_success_count using (context_name);
            ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
  
}

loinc2hpo_success_metric <- get_loinc2hpo_success_metric(force_rerun = FORCE_RERUN)

loinc2hpo_success_metric <- loinc2hpo_success_metric %>% mutate(across(function(x) is.numeric(x), function(x) replace_na(x, 0)))

loinc2hpo_success_metric %>% mutate(across(function(x) is.double(x), function(x) round(x, digits = 3))) %>%
  arrange(-n_test)
```
The overall success rate : `sum(loinc2hpo_success_metric$n_success) / sum(loinc2hpo_success_metric$n_test)`
```{r}
overall_success_rate <- sum(loinc2hpo_success_metric$n_success) / sum(loinc2hpo_success_metric$n_test)
print(glue('Total Lab Results: {sum(loinc2hpo_success_metric$n_test)}, 
           Total Lab Mapped to LOINC: {sum(loinc2hpo_success_metric$n_loinc_success)}
           Total Lab Transformed to HPO: {sum(loinc2hpo_success_metric$n_loinc2hpo_success)}'))

print(glue('Total LOINC Mapping Rate: {sum(loinc2hpo_success_metric$n_loinc_success)/sum(loinc2hpo_success_metric$n_test)},
           Total HPO transformation Rate: {sum(loinc2hpo_success_metric$n_loinc2hpo_success)/sum(loinc2hpo_success_metric$n_test)}'))
```


### Count patient distribution by the number of HPO terms per patient 
```{r}
# prepare a summary table: summary_hpo_counts_per_patient 
# rows: per patient
# columns: medical_record_number, hpo, unique hpo, abnormal_hpo, unique_abnormal_hpo, unique_abnormal_hpo_inference

# collect statistics for the starting cohort
# The mapping procedure assigned an average of 633 laboratory test-derived HPO terms per individual patient, many of which were from the same laboratory tests performed at different visits. The tests corresponded to a mean of 57.7 unique HPO terms, of which 20.8 were abnormalities and the remainder were normal phenotypes (Fig. 4e). The hierarchical structure of the HPO allows inferences to be propagated up to parent terms and their ancestors;14 using this method, we inferred an additional 51.2 HPO terms (total 73.5) based on 22.2 abnormalities for each patient
# how many phenotypes are mapped from lab tests? # unique phenotypes? then break down to normal and abnormal
# how many unique abnormal phenotypes for each patient? then after HPO inference

get_hpo_counts_per_patient <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/hpo_counts_per_patient.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
            with count_no_inference as (
            	select medical_record_number , count(*) as n_hpo, count(distinct case when isnegated then 'NOT' else '' end || hpotermid) as n_distinct_hpo
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab 
            	where hpotermid is not null
            	group by medical_record_number  
            ),
            count_abnormal_no_inference as (
            	select medical_record_number , count(distinct hpotermid) as n_distinct_abnormal_hpo
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab 
            	where hpotermid is not null and not isnegated 
            	group by medical_record_number
            ),
            count_abnormal_with_inference as (
            	select medical_record_number , count(distinct ancestor) as n_distinct_abnormal_hpo_infer
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab 
            	join hai_az_prod.hpo_is_a_pairs hiap on lab.hpotermid = hiap.current 
            	where hpotermid is not null and not isnegated 
            	group by medical_record_number
            )
            select c1.n_hpo, c1.n_distinct_hpo, c2.n_distinct_abnormal_hpo, c3.n_distinct_abnormal_hpo_infer 
            from cohort p 
            left join count_no_inference c1 using (medical_record_number) 
            left join count_abnormal_no_inference c2 using (medical_record_number)
            left join count_abnormal_with_inference c3 using (medical_record_number);
            ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

hpo_counts_per_patient <- get_hpo_counts_per_patient(force_rerun = FORCE_RERUN)
hpo_counts_per_patient <- hpo_counts_per_patient %>% 
  replace_na(list(n_hpo = 0, n_distinct_hpo = 0, n_distinct_abnormal_hpo = 0, n_distinct_abnormal_hpo_infer = 0))
```

Report out the patient level phenotype counts
```{r}
# mean
sapply(hpo_counts_per_patient, mean)

# median 
sapply(hpo_counts_per_patient, median)
```

Plot the distribution of distinct phenotypes for each patient (including abnormal and abnormal)
```{r}
plot_by_phenotypes_per_patient <- ggplot(hpo_counts_per_patient) +
  geom_histogram(aes(x = n_distinct_hpo, y = ..count../1000), binwidth = 10, fill = 'orange', color = 'black', size = 0.25) +
  xlab('number of unique phenotypes for each patient') +
  ylab('patient counts (in thousands)') + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_text(size = 8), axis.text = element_text(size = 8), 
        legend.text = element_text(size = 8), legend.title = element_text(size = 10))
ggsave(filename = glue("{CACHE_DIR}/plotByPhenotypesPerPatient.png"), plot = plot_by_phenotypes_per_patient, width = 3, height = 2)
plot_by_phenotypes_per_patient
```
Plot distribution of abnormal phenotypes (distinct) after inference
```{r}
plot_by_distinct_abnormal_hpo_infer_per_patient <- ggplot(hpo_counts_per_patient) +
  geom_histogram(aes(x = n_distinct_abnormal_hpo_infer, y = ..count../1000), binwidth = 10, fill = 'orange', color = 'black', size = 0.25) +
  xlab('number of unique phenotypes for each patient') +
  ylab('patient counts (in thousands)') + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_text(size = 8), axis.text = element_text(size = 8), 
        legend.text = element_text(size = 8), legend.title = element_text(size = 10))
ggsave(filename = glue("{CACHE_DIR}/plotByDistinctAbnormalPhenotypeInferPerPatient.png"), plot = plot_by_distinct_abnormal_hpo_infer_per_patient, width = 3, height = 2)
plot_by_distinct_abnormal_hpo_infer_per_patient
```

### Visualize patient phenotypic journey
```{r}
get_patient_lab_phenotype_journeys <- function(medical_record_numbers, force_rerun=FALSE, cache_dir=CACHE_DIR) {
  df_path = glue('{cache_dir}/patient_lab_phenotype_journey.csv')
  
  mrns_str <- str_c("'", medical_record_numbers, "'", collapse = ',')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, glue("
            with patient_lab_results as (
            	select *, date_part(year, lab_date) as lab_year
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july saelalhj 
            	where medical_record_number in ({mrns_str}) and hpotermid is not null 
            ),
            annual_phenotypes as (
            	select medical_record_number , lab_year, isnegated , hpotermid , count(*) as n 
            	from patient_lab_results 
            	group by medical_record_number , lab_year, isnegated , hpotermid
            ),
            annual_phenotypes_annotated as (
            	select *
            	from annual_phenotypes p
            	left join hai_az_prod.hpo h on p.hpotermid  = h.termid  
            	order by medical_record_number , lab_year, isnegated , hpotermid )
            select medical_record_number , lab_year, isnegated , hpotermid , n, label
            from annual_phenotypes_annotated
            order by medical_record_number , lab_year, isnegated , n desc, hpotermid
            ;
            "))
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

patient_lab_phenotype_journeys <- get_patient_lab_phenotype_journeys(medical_record_numbers = c('7611233'), force_rerun = FORCE_RERUN)
```

```{r}
patient_lab_phenotype_journeys_formated <- patient_lab_phenotype_journeys %>% 
  filter(medical_record_number == '7611233') %>% 
  select(-medical_record_number) %>% 
  group_by(lab_year, isnegated) %>% 
  slice_head(n = 5) %>% 
  mutate(display = glue('{hpotermid} {label} ({n} times)')) %>% 
  summarise(display = str_c(display, collapse = '\n'), .groups = 'drop')
write.csv(patient_lab_phenotype_journeys_formated, file = glue('{CACHE_DIR}/patient_lab_phenotype_journey_formatted.csv'))
```



### Collect patient counts for those with lab data at each year

```{r}
get_tested_patient_count_by_year <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_patient_count_by_year.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
            with scc_lab as (
            	select medical_record_number , calendar_date as lab_date, date_part('Year', lab_date) as lab_year
            	from hai_az_prod.lab_scc_2020july lsj
            ), 
            epic_lab as (
            	select mrn as medical_record_number, order_date as lab_date, date_part('Year', lab_date) as lab_year
            	from hai_az_test.lab_epic_2020july lej
            ),
            scc_and_epic as (
            	select * 
            	from scc_lab 
            	union all
            	select * 
            	from epic_lab
            )
            select lab_year, count(distinct medical_record_number) as n_patient
            from scc_and_epic 
            group by lab_year
            order by lab_year;
            ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

tested_patient_count_by_year <- get_tested_patient_count_by_year(force_rerun=FORCE_RERUN)
```

Collect tested patients by year, race and sex.

```{r}
get_tested_patient_count_by_year_race_sex <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_patient_count_by_year_race_sex.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
            with scc_lab as (
            	select medical_record_number , calendar_date as lab_date, date_part('Year', lab_date) as lab_year
            	from hai_az_prod.lab_scc_2020july lsj
            ), 
            epic_lab as (
            	select mrn as medical_record_number, order_date as lab_date, date_part('Year', lab_date) as lab_year
            	from hai_az_test.lab_epic_2020july lej
            ),
            scc_and_epic as (
            	select * 
            	from scc_lab 
            	union all
            	select * 
            	from epic_lab
            ),
            scc_and_epic_with_race as (
            	select lab.*, p.race, p.gender
            	from scc_and_epic lab
            	join hai_az_prod.person_msdw_2020july p using (medical_record_number)
            )
            select lab_year, race, gender, count(distinct medical_record_number) as n_patient
            from scc_and_epic_with_race
            group by lab_year, race, gender
            order by lab_year, race, gender;
            ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

tested_patient_count_by_year_race_sex <- get_tested_patient_count_by_year_race_sex(force_rerun=FORCE_RERUN)
```

### Analyze changes of observed phenotypes
We will used the persisted lab test table for this analysis. 
```{r}
get_phenotype_rank_all_by_year <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/observed_phenotype_rank_all_by_year.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
      with abnormal_lab as 
      	(select * from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab where hpotermid is not null and not isnegated),
      abnormal_lab_after_infer as 
      	(SELECT l.medical_record_number, l.lab_date, date_part(year, lab_date) as lab_year, l.local_test_code, l.loinc, l.hpotermid, l.isnegated, pair.ancestor , pair.distance
      	FROM abnormal_lab l 
      	left join hai_az_prod.hpo_is_a_pairs pair on l.hpotermid = pair.current),
      lab_freq_by_year as (
      	select ancestor as termid, lab_year, count(*) as n_record, count(distinct medical_record_number) as n_patient from abnormal_lab_after_infer group by ancestor, lab_year
      )
      select *
      from lab_freq_by_year
      join hai_az_prod.hpo h using (termid)
      order by lab_year, distancetoroot;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

phenotype_rank_all_by_year <- get_phenotype_rank_all_by_year(force_rerun = FORCE_RERUN)


get_phenotype_rank_all_by_year_race_sex <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/observed_phenotype_rank_all_by_year_race_sex.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
      with abnormal_lab as 
      	(select * 
      	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab 
      	where hpotermid is not null and not isnegated
      	),
      abnormal_lab_after_infer as 
      	(SELECT l.medical_record_number, l.lab_date, date_part(year, lab_date) as lab_year, l.local_test_code, l.loinc, l.hpotermid, l.isnegated, pair.ancestor , pair.distance
      	FROM abnormal_lab l 
      	left join hai_az_prod.hpo_is_a_pairs pair on l.hpotermid = pair.current),
      lab_freq_by_year_race_sex as (
      	select ancestor as termid, lab_year, p.race, p.gender, count(*) as n_record, count(distinct medical_record_number) as n_patient 
      	from abnormal_lab_after_infer 
      	join hai_az_prod.person_msdw_2020july p using (medical_record_number)
      	group by ancestor, lab_year, p.race, p.gender
      )
      select *
      from lab_freq_by_year_race_sex
      join hai_az_prod.hpo h using (termid)
      order by lab_year, distancetoroot;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

phenotype_rank_all_by_year_race_sex <- get_phenotype_rank_all_by_year_race_sex(force_rerun = FORCE_RERUN)
```


```{r}
fancy_scientific <- function(l) {
     # turn in to character string in scientific notation
     l <- format(l, scientific = TRUE)
     # quote the part before the exponent to keep all the digits
     l <- gsub("^(.*)e", "'\\1'e", l)
     # turn the 'e+' into plotmath format
     l <- gsub("e", "%*%10^", l)
     # return this as an expression
     parse(text=l)
}

plot_phenotypes_of_interest_by_year <- function(terms_of_interest, df, normalize=TRUE){
  hpo_terms_selected <- df %>% filter(termid %in% terms_of_interest) %>% select(termid, label) %>% distinct()
  
  y_str = ifelse(normalize, 'n_patient/n_tested', 'n_patient')
  y_label = ifelse(normalize, 'patient fraction normalized to database size', 'patient count')

  p <- df %>% filter(termid %in% terms_of_interest) %>% 
    filter(lab_year <= 2019 & lab_year > 2000) %>%
    ggplot(aes(x = lab_year, y = eval(parse(text=y_str)), group = termid, color = termid)) + 
    geom_point() +
    geom_line() +
    scale_color_discrete(breaks = hpo_terms_selected$termid, labels = str_c(hpo_terms_selected$termid, hpo_terms_selected$label, sep = " ")) +
    xlab('Year') +
    ylab(y_label) +
    theme_bw() +
    theme(panel.grid = element_blank(),
        axis.title = element_text(size = 8), axis.text = element_text(size = 8), 
        legend.text = element_text(size = 8), legend.title = element_text(size = 10))
  
  return (p)
}



hpo_level_1_terms <- phenotype_rank_all_by_year %>% filter(distancetoroot == 1) %>% select(termid, label) %>% distinct()
p <- plot_phenotypes_of_interest_by_year(terms_of_interest = hpo_level_1_terms$termid, df=phenotype_rank_all_by_year, normalize = FALSE)
ggsave(filename = glue('{CACHE_DIR}/plot_abnormal_phenotypes_by_year_level_1.pdf'), plot = p, width = 8, height = 4)
p
```

```{r}
hpo_level_1_terms <- phenotype_rank_all_by_year %>% filter(distancetoroot == 1) %>% select(termid, label) %>% distinct()
p <- plot_phenotypes_of_interest_by_year(terms_of_interest = hpo_level_1_terms$termid, df= phenotype_rank_all_by_year %>%
                                           left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year'), normalize = TRUE)
ggsave(filename = glue('{CACHE_DIR}/plot_abnormal_phenotypes_by_year_level_1_normalized.pdf'), plot = p, width = 8, height = 4)
p
```

Which trend line in the above plot are statistically significant?
```{r}
df= phenotype_rank_all_by_year %>% left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year')
trendline_lm_test <- df %>% 
  filter(distancetoroot == 1) %>% 
  filter(lab_year > 2000) %>% 
  mutate(fraction = n_patient / n_tested) %>%
  select(termid, lab_year, label, fraction) %>% 
  group_by(termid, label) %>% 
  nest() %>% 
  mutate(lm_model = map(data, function(d) lm(fraction ~ lab_year, data = d))) %>%
  mutate(lm_coeff = map(lm_model, broom::tidy)) %>%
  select(-data, -lm_model) %>% 
  unnest(lm_coeff) %>% 
  filter(term == 'lab_year') %>% 
  mutate(p.value.bonferroni = p.value * 10)

symnum(trendline_lm_test$p.value.bonferroni, cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, Inf), symbols = c("***", "**", "*", ".", " "))
  
trendline_lm_test_formatted <- trendline_lm_test %>% select(termid, label, estimate, p.value, p.value.bonferroni) %>% 
  arrange(p.value.bonferroni) %>%
  rename(beta = estimate) %>% 
  mutate(significance = symnum(p.value.bonferroni, cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, Inf), symbols = c("***", "**", "*", ".", " ")) ) %>% 
  mutate(across(.cols = function(x) is.double(x), function(x) scales::scientific(x, digits = 3)))
  

write.csv(trendline_lm_test_formatted, file = glue('{CACHE_DIR}/table_abnormal_phenotypes_by_year_level_1_normalized_trendline_lm_model.csv'), row.names=FALSE)

trendline_lm_test_formatted
```


### Analyze the tested phenotypes 

Whether a lab test is ordered or not can sometimes be very informative. In this section, we will analyze the most tested phenotypes.

Some phenotypes can be directly tested, such as "Increased LDL cholesterol concentration". Other phenotypes can be inferred from directly testable phenotypes, such as "Abnormal Leukocyte count", which are inferred from specific tests on different blood cell counts. We collect the count of phenotypes directly tested, or including indirectly tested ones as well.

```{r}
get_tested_phenotype_rank_direct <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_direct.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
      with testable_phenotypes_direct as (
    	select lab.medical_record_number , lab.context_name , lab.lab_date , lab.lab_time , lab.loinc , testable.termid , testable.is_tested_directly 
    	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
    	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
    	where testable.is_tested_directly 
    ),
    testable_phenotype_direct_freq as (
    	select termid, count(*) as n_record, count(distinct medical_record_number) as n_patient
    	from testable_phenotypes_direct
    	group by termid 
    )
    select testable.*, hpo.label
    from testable_phenotype_direct_freq testable
    join hai_az_prod.hpo hpo on testable.termid = hpo.termid
    order by n_record desc;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

get_tested_phenotype_rank_all <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_all.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
               with testable_phenotypes_all as (
              	select lab.medical_record_number , lab.context_name , lab.lab_date , lab.lab_time , lab.loinc , testable.termid , testable.is_tested_directly 
              	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
              	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
              	--where testable.is_tested_directly 
              ),
              testable_phenotype_all_freq as (
              	select termid, count(*) as n_record, count(distinct medical_record_number) as n_patient
              	from testable_phenotypes_all
              	group by termid 
              )
              select testable.*, hpo.label, hpo.distancetoroot 
              from testable_phenotype_all_freq testable
              join hai_az_prod.hpo hpo on testable.termid = hpo.termid
              order by n_record desc;
              ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

tested_phenotype_rank_direct <- get_tested_phenotype_rank_direct(force_rerun = FORCE_RERUN)
tested_phenotype_rank_all <- get_tested_phenotype_rank_all(force_rerun = FORCE_RERUN)
```


For the directly tested phenotypes, we can observe what are the most tested abnormalities in one healthcare system. 
```{r}
tested_phenotype_rank_direct %>% head(10) %>% formattable::formattable()
```


For the directly/indirectly tested phenotypes, we can determine at the higher level, what are the most tested abnormalities. 
```{r max.output=-1}
tested_phenotype_rank_all %>% filter(distancetoroot == 1) %>% arrange(-n_record) %>% select(-distancetoroot)
```



Plot the annual change of tested phenotypes. 

```{r}
get_tested_phenotype_rank_all_by_year <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_all_by_year.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <-  dbGetQuery(dsca, "
              with testable_phenotypes_direct as (
              	select lab.medical_record_number , person.race, lab.context_name , lab.lab_date , lab.lab_time , date_part(year, lab_date) as lab_year, lab.loinc , testable.termid , testable.is_tested_directly 
              	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
              	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
              	join hai_az_prod.person_msdw_2020july person using (medical_record_number)
              	--where testable.is_tested_directly 
              ),
              testable_phenotype_direct_freq as (
              	select termid, lab_year, count(*) as n_record, count(distinct medical_record_number) as n_patient
              	from testable_phenotypes_direct
              	group by termid, lab_year
              )
              select testable.*, hpo.label, hpo.distancetoroot 
              from testable_phenotype_direct_freq testable
              join hai_az_prod.hpo hpo on testable.termid = hpo.termid
              order by termid, lab_year;
              ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

tested_phenotype_rank_all_by_year <- get_tested_phenotype_rank_all_by_year(force_rerun = FORCE_RERUN)
```

```{r}
hpo_level_1_terms <- tested_phenotype_rank_all_by_year %>% filter(distancetoroot == 1) %>% select(termid, label) %>% distinct()
p <- plot_phenotypes_of_interest_by_year(terms_of_interest = hpo_level_1_terms$termid, df=tested_phenotype_rank_all_by_year, normalize = FALSE)
ggsave(filename = glue('{CACHE_DIR}/plot_tested_phenotypes_by_year_level_1.pdf'), plot = p, width = 8, height = 4)
p
```
```{r}
p <- plot_phenotypes_of_interest_by_year(terms_of_interest = hpo_level_1_terms$termid, df=tested_phenotype_rank_all_by_year %>% left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year'), normalize = TRUE)
ggsave(filename = glue('{CACHE_DIR}/plot_tested_phenotypes_by_year_level_1_normalized.pdf'), plot = p, width = 8, height = 4)
p
```


```{r}
df= tested_phenotype_rank_all_by_year %>% left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year')
trendline_lm_test <- df %>% 
  filter(distancetoroot == 1) %>% 
  filter(lab_year > 2000) %>% 
  mutate(fraction = n_patient / n_tested) %>%
  select(termid, lab_year, label, fraction) %>% 
  group_by(termid, label) %>% 
  nest() %>% 
  mutate(lm_model = map(data, function(d) lm(fraction ~ lab_year, data = d))) %>%
  mutate(lm_coeff = map(lm_model, broom::tidy)) %>%
  select(-data, -lm_model) %>% 
  unnest(lm_coeff) %>% 
  filter(term == 'lab_year') %>% 
  mutate(p.value.bonferroni = p.value * 11)
  
trendline_lm_test_formatted <- trendline_lm_test %>% select(termid, label, estimate, p.value, p.value.bonferroni) %>% 
  arrange(p.value.bonferroni) %>%
  rename(beta = estimate) %>% 
  mutate(significance = symnum(p.value.bonferroni, cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, Inf), symbols = c("***", "**", "*", ".", " ")) ) %>% 
  mutate(across(.cols = function(x) is.double(x), function(x) scales::scientific(x, digits = 3)))
  

write.csv(trendline_lm_test_formatted, file = glue('{CACHE_DIR}/table_tested_phenotypes_by_year_level_1_normalized_trendline_lm_model.csv'), row.names=FALSE)

trendline_lm_test_formatted
```


Some trends are pretty interesting, such as the spike of Abnormal cellular phenotype. The term has three children, but only one is tested: HP:0011017 Abnormal cellular physiology

```{r}
children_abnormal_cellular_physiology <- c('HP:0003220', 'HP:0011018', 'HP:0025463', 'HP:0011019', 'HP:0003254', 'HP:4000056', 'HP:0011133', 'HP:0004371', 'HP:0031377', 'HP:0031409', 'HP:0012103', 'HP:0032576', 'HP:0003204', 'HP:0004356', 'HP:0032571', 'HP:0002916', 'HP:0003224', 'HP:0003575', 'HP:0003358')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_abnormal_cellular_physiology, df=tested_phenotype_rank_all_by_year %>% left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year'))
```

Again, the above plot shows that it is driven by one HP:0031409 Abnormal lymphocyte physiology. 
```{r}
children_of_interest <- c('HP:0011840', 'HP:0030886', 'HP:0012177', 'HP:0005372', 'HP:0031378')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_of_interest, df=tested_phenotype_rank_all_by_year %>% left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year'))
```
```{r}
children_of_interest <- c('HP:0002847', 'HP:0002959', 'HP:0005384', 'HP:0041076', 'HP:0010701')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_of_interest, df=tested_phenotype_rank_all_by_year %>% left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year'))
```


```{r}
children_of_interest <- c('HP:0010702', 'HP:0032336', 'HP:0410241', 'HP:0410240', 'HP:0410243', 'HP:0410242', 'HP:0410244', 'HP:0004313')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_of_interest, df=tested_phenotype_rank_all_by_year %>% left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year'))
```

Find what local lab codes are mapped to HP:0010702 Increased circulating antibody level and find which are tested more often after 2017.
```{r}
get_tested_phenotype_spike_by_loinc_year <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_spike_by_loinc_year.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <-  dbGetQuery(dsca, "
              with lab_spike as (
            	select context_name , lab.loinc , ltp.termid , date_part('Year', lab_date) as lab_year, count(*) as n_record, count(distinct medical_record_number) as n_patient
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab 
            	join hai_az_prod.loinc_testable_phenotypes ltp on lab.loinc = ltp.loincid 
            	where ltp.termid = 'HP:0010702'
            	group by context_name , lab.loinc , ltp.termid, date_part('Year', lab_date)
            )
            select l.*
            from lab_spike l
            order by context_name , loinc , lab_year;
              ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}


get_tested_phenotype_spike_by_localcode_year <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_spike_by_localcode_year.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <-  dbGetQuery(dsca, "
              with lab_spike as (
            	select context_name , local_test_code , ltp.termid, date_part('Year', lab_date) as lab_year, count(*) as n_record, count(distinct medical_record_number) as n_patient
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab 
            	join hai_az_prod.loinc_testable_phenotypes ltp on lab.loinc = ltp.loincid 
            	where ltp.termid = 'HP:0010702'
            	group by context_name , local_test_code ,ltp.termid,  date_part('Year', lab_date)
            ),
            local_lab_names as (
            	select distinct source, code, test_name
            	from hai_az_prod.loinc_mapping lm 
            )
            select l.*, r.test_name
            from lab_spike l
            join local_lab_names r on l.local_test_code = r.code
            order by context_name , local_test_code , lab_year;
              ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}


tested_phenotype_spike_by_loinc_year <- get_tested_phenotype_spike_by_loinc_year(force_rerun = FORCE_RERUN)
tested_phenotype_spike_by_localcode_year <- get_tested_phenotype_spike_by_localcode_year(force_rerun = FORCE_RERUN)
```

We can see the spike is caused by LOINC:10834-0 Globulin [Mass/volume] in Serum by calculation. 

The SCC spike is for LOINC:2465-3 IgG [Mass/volume] in Serum or Plasma. The increase is significant, but the raw count is still negligible. 
```{r}
tested_phenotype_spike_by_loinc_year %>% 
  left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year') %>%
    filter(lab_year <= 2019 & lab_year > 2000) %>%
  #filter(loinc == '10834-0') %>%
    ggplot(aes(x = lab_year, y = n_patient/n_tested, group = loinc, color = loinc)) + 
    geom_point() +
    geom_line() +
    #scale_color_discrete(breaks = loinc, labels = str_c('LOINC', loinc, sep = ":")) +
    ylab('patient fraction among tested') +
  facet_wrap(~context_name, nrow = 2, scales = 'free_y')
```

Similarly, if we use local codes for the plot, we can also see that EPIC lab test 3277 caused the spike, which has a name of "GLOBULIN". 
```{r}
tested_phenotype_spike_by_localcode_year %>% 
  left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year') %>%
    filter(lab_year <= 2019 & lab_year > 2000) %>%
  group_by(context_name, local_test_code) %>%
  mutate(min_year = min(lab_year), max_year = max(lab_year), max_min_year = max_year - min_year) %>%
  filter(max_min_year > 2) %>%
    ggplot(aes(x = lab_year, y = n_patient/n_tested, group = local_test_code, color = local_test_code)) + 
    geom_point() +
    geom_line() +
    #scale_color_discrete(breaks = loinc, labels = str_c('LOINC', loinc, sep = ":")) +
    ylab('patient fraction among tested') +
  theme(legend.position = 'bottom') +
  facet_wrap(~context_name, nrow = 2, scales = 'free_y')
```

### Analyze racial differences

#### racial differences of tested phenotypes

The section analyzed whether there are racial differences in tested phenotypes. The problem is that we saw the vast majority of terms have differences. This is probably just a large number effect. 

```{r}
get_tested_phenotype_rank_direct_by_race <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_direct_by_race.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
              with testable_phenotypes_direct as (
            	select lab.medical_record_number , person.race, lab.context_name , lab.lab_date , lab.lab_time , lab.loinc , testable.termid , testable.is_tested_directly 
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
            	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
            	join hai_az_prod.person_msdw_2020july person using (medical_record_number)
            	where testable.is_tested_directly 
            ),
            testable_phenotype_direct_freq as (
            	select termid, race, count(*) as n_record, count(distinct medical_record_number) as n_patient
            	from testable_phenotypes_direct
            	group by termid, race
            )
            select testable.*, hpo.label
            from testable_phenotype_direct_freq testable
            join hai_az_prod.hpo hpo on testable.termid = hpo.termid
            order by termid, race;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

get_tested_phenotype_rank_all_by_race <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_all_by_race.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <-  dbGetQuery(dsca, "
              with testable_phenotypes_direct as (
              	select lab.medical_record_number , person.race, lab.context_name , lab.lab_date , lab.lab_time , lab.loinc , testable.termid , testable.is_tested_directly 
              	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
              	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
              	join hai_az_prod.person_msdw_2020july person using (medical_record_number)
              	--where testable.is_tested_directly 
              ),
              testable_phenotype_direct_freq as (
              	select termid, race, count(*) as n_record, count(distinct medical_record_number) as n_patient
              	from testable_phenotypes_direct
              	group by termid, race
              )
              select testable.*, hpo.label, hpo.distancetoroot
              from testable_phenotype_direct_freq testable
              join hai_az_prod.hpo hpo on testable.termid = hpo.termid
              order by termid, race;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

get_tested_phenotype_rank_all_by_race_year_sex <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_all_by_race_year_sex.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <-  dbGetQuery(dsca, "
              with testable_phenotypes_direct as (
              	select lab.medical_record_number , person.race, person.gender , lab.context_name , lab.lab_date , lab.lab_time , date_part(year, lab_date) as lab_year, lab.loinc , testable.termid , testable.is_tested_directly 
              	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
              	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
              	join hai_az_prod.person_msdw_2020july person using (medical_record_number)
              --where testable.is_tested_directly 
                ),
                testable_phenotype_direct_freq as (
                	select termid, lab_year, race, gender, count(*) as n_record, count(distinct medical_record_number) as n_patient
                	from testable_phenotypes_direct
                	group by termid, lab_year, race, gender
                )
                select testable.*, hpo.label, hpo.distancetoroot
                from testable_phenotype_direct_freq testable
                join hai_az_prod.hpo hpo on testable.termid = hpo.termid
                order by termid, lab_year, race, gender;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

tested_phenotype_rank_direct_by_race <- get_tested_phenotype_rank_direct_by_race(force_rerun = FORCE_RERUN)
tested_phenotype_rank_all_by_race <- get_tested_phenotype_rank_all_by_race(force_rerun = FORCE_RERUN)
tested_phenotype_rank_all_by_race_year_sex <- get_tested_phenotype_rank_all_by_race_year_sex(force_rerun = FORCE_RERUN)
```


For each directly measured phenotype, we can determine whether race and the tests are correlated by some form of Chi-squared test. The current problem is that the most phenotype terms are statistically significant. 
@TODO we should look at phenotypes at each year. 
```{r}
countByRace <- patient_race_sex_distribution %>% 
  group_by(race) %>% 
  summarise(dbtotal = sum(n))


phenotype_race_chisq_test <- function(df) {
  broom::tidy(chisq.test(df$observed, p = df$dbtotal/sum(df$dbtotal)))
}

phenotype_race_prop_test <- function(df){
  broom::tidy(prop.test(df$observed, p = df$observed/sum(df$dbtotal)))
}


tested_phenotype_rank_direct_by_race %>% 
  select(termid, label, race, n_patient) %>% 
  rename(observed = n_patient) %>% 
  group_by(termid, label) %>% 
  nest() %>% 
  mutate(data = map(data, function(d) d %>% 
                      right_join(countByRace, by = 'race') %>%
                      replace_na(list(termid = first(.$termid), label = first(.$label), observed = 0)))) %>% 
  mutate(chisq = map(data, phenotype_race_chisq_test)) %>% 
  select(-data) %>% 
  unnest(chisq) %>% 
  arrange(-p.value) %>% 
  head()
```

```{r}
tested_phenotype_rank_all_by_race %>% filter(distancetoroot == 1) %>% 
  select(termid, label, race, n_patient) %>% 
  rename(observed = n_patient) %>% 
  group_by(termid, label) %>% 
  nest() %>% 
  mutate(data = map(data, function(d) d %>% 
                      right_join(countByRace, by = 'race') %>%
                      replace_na(list(termid = first(.$termid), label = first(.$label), observed = 0)))) %>% 
  mutate(chisq = map(data, phenotype_race_chisq_test)) %>% 
  select(-data) %>% 
  unnest(chisq) %>% 
  arrange(-p.value) %>% 
  head()
```

#### racial differences of observed abnormal phenotypes by races
An improved version of racial analysis: 
Question: for each race, is it more likely to have a certain abnormal phenotype than the rest of the population?

To do this, we will run Chisq test but on annual basis. 
```{r}
tested_patient_count_by_year_race <- tested_patient_count_by_year_race_sex %>% 
  group_by(lab_year, race) %>% 
  summarise(dbtotal = sum(n_patient), .groups = 'drop')

tested_patient_count_by_year_race %>% filter(lab_year == 2019)
```



```{r}
RACE_OF_INTEREST <- 'Black or African American'
df <- phenotype_rank_all_by_year_race_sex %>% 
  group_by(termid, label, lab_year, race) %>% 
  summarise(observed = sum(n_patient), .groups = 'drop') %>% 
  right_join(tested_patient_count_by_year_race, by = c('lab_year', 'race')) %>% 
  filter(lab_year == 2019) %>% 
  ##filter(termid == 'HP:0003351')
  filter(termid == 'HP:0000079') 


cm <- df %>%
  mutate(roi = if_else(race == RACE_OF_INTEREST, 'isROI', 'notROI')) %>% 
  group_by(roi) %>% 
  summarise(observed = sum(observed), dbtotal = sum(dbtotal)) %>% 
  ungroup() %>%
  mutate(not_observed = dbtotal - observed) %>% 
  select(-dbtotal) %>%
  column_to_rownames('roi') %>% 
  t() %>% 
  as.matrix()

broom::tidy(fisher.test(cm))

## write a function to test the statistical difference for each race
racial_abnormality_statistical_test <- function(df){
  if (nrow(df) <= 1) {
    return (NULL)
  }
  fisher_tests_races <- list()
  for (RACE_OF_INTEREST in df$race){
    cm <- df %>%
        mutate(roi = if_else(race == RACE_OF_INTEREST, 'isROI', 'notROI')) %>% 
        group_by(roi) %>% 
        summarise(observed = sum(observed), dbtotal = sum(dbtotal)) %>% 
        ungroup() %>%
        mutate(not_observed = dbtotal - observed) %>% 
        select(-dbtotal) %>%
        column_to_rownames('roi') %>% 
        t() %>% 
        as.matrix()
    if (length(cm) == 4){
       fisher_test_coeff <- broom::tidy(fisher.test(cm))
    } else {
       fisher_test_coeff <- data.frame(estimate = numeric(), p.value = numeric(), conf.low = numeric(), conf.high = numeric(), method = '', alternative = '')
    }
    fisher_test_coeff <- fisher_test_coeff %>% mutate(race = RACE_OF_INTEREST) %>% 
      select(race, everything())
    fisher_tests_races[[length(fisher_tests_races) + 1]] <- fisher_test_coeff
  }
  fisher_test_coeffs <- bind_rows(fisher_tests_races)
  ##return (df %>% left_join(fisher_test_coeffs, by = 'race'))
  return (fisher_test_coeffs)
}

racial_abnormality_statistical_test(df)

library(furrr)

plan(multisession, workers = 8)

racial_abnormality_fisher <- phenotype_rank_all_by_year_race_sex %>% 
  group_by(termid, label, lab_year, race) %>% 
  summarise(observed = sum(n_patient), .groups = 'drop') %>% 
  right_join(tested_patient_count_by_year_race, by = c('lab_year', 'race')) %>% 
  #filter(lab_year == 2019) %>% 
  #filter(termid %in% c('HP:0003351', 'HP:0000079')) %>% 
  group_by(lab_year, termid, label) %>% 
  nest() %>% 
  ungroup() %>% 
  mutate(fisher_coeff = future_map(data, racial_abnormality_statistical_test)) %>% 
  select(-data) %>% 
  unnest(fisher_coeff)

racial_abnormality_fisher %>% nrow()

write.csv(racial_abnormality_fisher, file = glue('{CACHE_DIR}/racial_abnormality_fisher.csv'), row.names = FALSE)

p <- racial_abnormality_fisher %>% filter(between(lab_year, 2003, 2019)) %>% 
  #filter(race == 'Black or African American') %>% 
  #filter(race == 'White') %>%
  filter(race %in% c('White', 'Black or African American', 'Asian')) %>% 
  filter(termid %in% hpo_level_1_terms$termid) %>% 
  {
    ggplot(., aes(x = lab_year, y = estimate, group = termid, color = termid)) + 
    geom_point() +
    geom_line() +
    scale_color_discrete(breaks = .$termid, labels = str_c(.$termid, .$label, sep = " ")) +
    #geom_hline(yintercept = c(0.8, 1.2), color = 'red', linetype = 'dotted') +
    annotate(geom='rect', ymin = 0.8, ymax = 1.2, xmin = -Inf, xmax = Inf, fill = 'magenta', alpha = 0.2) +
    geom_hline(yintercept = 1, color = 'black') +
    xlab('Year') +
    ylab('odds ratio') +
    theme_bw() +
    theme(panel.grid = element_blank(), legend.position = 'right',
        axis.title = element_text(size = 8), axis.text = element_text(size = 8), 
        legend.text = element_text(size = 8), legend.title = element_text(size = 10)) +
    facet_wrap(~race, ncol = 1)
  }

ggsave(filename = glue('{CACHE_DIR}/plot_by_phenotype_racial_difference_over_years.pdf'), plot = p, width = 8, height = 8)
 
p
```


```{r}
RACE_OF_INTEREST <- 'Black or African American'
df <- tested_phenotype_rank_all_by_race_year_sex %>% 
  group_by(termid, label, lab_year, race) %>% 
  summarise(observed = sum(n_patient), .groups = 'drop') %>% 
  right_join(tested_patient_count_by_year_race, by = c('lab_year', 'race')) %>% 
  filter(lab_year == 2019) %>% 
  ##filter(termid == 'HP:0003351')
  filter(termid == 'HP:0000079') 


cm <- df %>%
  mutate(roi = if_else(race == RACE_OF_INTEREST, 'isROI', 'notROI')) %>% 
  group_by(roi) %>% 
  summarise(observed = sum(observed), dbtotal = sum(dbtotal)) %>% 
  ungroup() %>%
  mutate(not_observed = dbtotal - observed) %>% 
  select(-dbtotal) %>%
  column_to_rownames('roi') %>% 
  t() %>% 
  as.matrix()

broom::tidy(fisher.test(cm))

racial_abnormality_statistical_test(df)

library(furrr)

plan(multisession, workers = 8)

racial_tested_abnormality_fisher <- tested_phenotype_rank_all_by_race_year_sex %>%
  group_by(termid, label, lab_year, race) %>%
  summarise(observed = sum(n_patient), .groups = 'drop') %>%
  right_join(tested_patient_count_by_year_race, by = c('lab_year', 'race')) %>%
  #filter(lab_year == 2019) %>%
  #filter(termid %in% c('HP:0003351', 'HP:0000079')) %>%
  group_by(lab_year, termid, label) %>%
  nest() %>%
  ungroup() %>%
  mutate(fisher_coeff = future_map(data, racial_abnormality_statistical_test)) %>%
  select(-data) %>%
  unnest(fisher_coeff)

racial_tested_abnormality_fisher %>% nrow()

write.csv(racial_tested_abnormality_fisher, file = glue('{CACHE_DIR}/racial_tested_abnormality_fisher.csv'), row.names = FALSE)

p <- racial_tested_abnormality_fisher %>% filter(between(lab_year, 2003, 2019)) %>%
  #filter(race == 'Black or African American') %>%
  #filter(race == 'White') %>%
  filter(race %in% c('White', 'Black or African American', 'Asian')) %>%
  filter(termid %in% hpo_level_1_terms$termid) %>%
  {
    ggplot(., aes(x = lab_year, y = estimate, group = termid, color = termid)) +
    geom_point() +
    geom_line() +
    scale_color_discrete(breaks = .$termid, labels = str_c(.$termid, .$label, sep = " ")) +
    #geom_hline(yintercept = c(0.8, 1.2), color = 'red', linetype = 'dotted') +
    annotate(geom='rect', ymin = 0.8, ymax = 1.2, xmin = -Inf, xmax = Inf, fill = 'magenta', alpha = 0.2) +
    geom_hline(yintercept = 1, color = 'black') +
    xlab('Year') +
    ylab('odds ratio') +
    theme_bw() +
    theme(panel.grid = element_blank(), legend.position = 'right',
        axis.title = element_text(size = 8), axis.text = element_text(size = 8),
        legend.text = element_text(size = 8), legend.title = element_text(size = 10)) +
    facet_wrap(~race, ncol = 1)
  }

ggsave(filename = glue('{CACHE_DIR}/plot_by_tested_phenotype_racial_difference_over_years.pdf'), plot = p, width = 8, height = 8)

p
```

For each race, identify the most over-tested phenotypes between 2003 and 2019. 
```{r}
overly_tested_abnormalities_by_each_race_top10 <- racial_tested_abnormality_fisher %>% 
  ## bring in how many patients were tested for each abnormality
  inner_join(tested_phenotype_rank_all_by_race_year_sex %>% 
              group_by(termid, lab_year, race) %>% 
              summarise(n_record = sum(n_record), n_patient = sum(n_patient), .groups = 'drop'), 
             by = c('termid', 'lab_year', 'race')) %>% 
  filter(race %in% c('White', 'Black or African American', 'Asian')) %>%
  ## focus on data between 2003 and 2019
  filter(between(lab_year, 2003, 2019)) %>% 
  group_by(termid, label, race) %>% 
  summarise(median_estimate = median(estimate), 
            n_record = sum(n_record),
            n_patient = sum(n_patient),
            .groups = 'drop') %>% 
  arrange(desc(median_estimate)) %>%
  ## do not focus on rarely tested abnormalities
  ## here we require at least 17 years X 100 patient/year have been tested for the abnormality
  filter(n_patient > 1700) %>% 
  ## find top 10 within each race
  group_by(race) %>% 
  slice_head(n=10) %>% 
  ## give some nicer names
  rename(median_OR = median_estimate,
         lab_record = n_record,
         patient_count = n_patient)

write.csv(overly_tested_abnormalities_by_each_race_top10, file=glue('{CACHE_DIR}/overly_tested_abnormalities_by_each_race_top10.csv'), row.names = FALSE)

overly_tested_abnormalities_by_each_race_top10 %>% 
  ungroup() %>% 
  #filter(race == 'Asian') %>% 
  rename(OR = median_OR) %>% 
  rename(`Lab Record` = lab_record) %>% 
  rename(`Patient Count` = patient_count) %>% 
  mutate(OR = round(OR, digits = 3)) %>%
  group_by(race) %>% 
  nest() %>% {
    walk2(.$race, .$data, 
          function(race_name, df) sjPlot::tab_df(df, 
                                                 alternate.rows = TRUE, 
                                                 title = glue("Top 10 Overly Tested Lab Phenotype for {race_name}"), 
                                                 use.viewer = FALSE, 
                                                 file = glue('{CACHE_DIR}/table_overly_tested_abnormalities_for_{race_name}_top10.html')))
  }
  
race_name = 'Asian'
table_overly_tested_by_race <- function(race_name){
  df <- overly_tested_abnormalities_by_each_race_top10 %>% 
    ungroup() %>% 
    filter(race == race_name) %>% 
    rename(OR = median_OR) %>% 
    rename(`Lab Record` = lab_record) %>% 
    rename(`Patient Count` = patient_count) %>% 
    mutate(OR = round(OR, digits = 3)) %>%
    select(-race) 

  sjPlot::tab_df(df, alternate.rows = TRUE, 
                     title = glue("Top 10 Overly Tested Lab Phenotype for {race_name}: 2003 - 2019"), 
                 footnote = 'OR: odds of having received lab tests for the phenotype in the race vs other races; <br>
                phenotypes with less than 1700 tested patients were excluded',
                 show.footnote = TRUE,
                     use.viewer = FALSE, 
                     file = glue('{CACHE_DIR}/table_overly_tested_abnormalities_for_{race_name}_top10.html'))
}
table_overly_tested_by_race(race_name = 'Asian')
table_overly_tested_by_race(race_name = 'Black or African American')
table_overly_tested_by_race(race_name = 'White')
```

