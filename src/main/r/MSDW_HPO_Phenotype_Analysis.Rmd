---
title: "LOINC2HPO_EPIC AND SCC"
output:
  html_document:
    df_print: paged
---

## GOAL
This is to LOINC2HPO analysis of both EPIC and SCC labs. 
```{r message=FALSE}
library(tidyverse)
library(glue)
library(readxl)
require(DBI)
require(RPostgres)
require(egg)
require(gridExtra)
source('.db_credential.R')
dsca <- DBI::dbConnect(RPostgres::Postgres(), host='localhost', user=user, dbname = dbname, port = 2345, password=password)
```


## ANALYSIS

```{r}
CACHE_DIR = 'cache'
if (!dir.exists(CACHE_DIR)){
  dir.create(CACHE_DIR)
}

get_db_data <- function(sql, df_path, force_rerun=FALSE, cache_dir=CACHE_DIR){
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, sql)
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}
```

### Collect patient basic demographics
```{r}
get_patient_race_sex_distribution <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/patient_count_by_race_sex.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
            select race, gender, count(*) as n
            from hai_az_prod.person_msdw_2020july pmj 
            group by race, gender 
            order by race, gender;
            ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
  
}

patient_race_sex_distribution <- get_patient_race_sex_distribution()

# recode all unknown gender as one category
patient_race_sex_distribution <- patient_race_sex_distribution %>% 
  mutate(gender = recode(gender, 'MSDW_NOT APPL' = 'Unknown')) %>%
  mutate(gender = recode(gender, 'MSDW_OTHER' = 'Unknown')) %>%
  mutate(gender = recode(gender, 'MSDW_UNKNOWN' = 'Unknown')) %>%
  mutate(gender = recode(gender, 'NOT AVAILABLE'= 'Unknown')) %>%
  mutate(gender = recode(gender, .missing = 'Unknown'))

# recode "African American" as "Black or African American"
# TODO: update the race map
patient_race_sex_distribution <- patient_race_sex_distribution %>%
  mutate(race = recode(race, 'African American' = 'Black or African American'))
```

```{r}
countByGender <- patient_race_sex_distribution %>% 
  group_by(gender) %>% 
  summarise(n = sum(n))

plot_by_sex <- ggplot(countByGender) + 
  geom_bar(aes(x = 1, y = n / sum(n), fill = gender), stat = "identity") + 
  scale_fill_manual(name = "Sex", values = c(Male = "royalblue", Female = "lightcoral", Indeterminant = 'Cyan', Unknown = 'Orange')) + 
  xlab("") + ylab("patient count") +
  coord_polar(theta = "y") + 
  theme_bw() + 
  theme(panel.grid = element_blank(), legend.position = c(0.25, 0.7), 
        axis.text = element_blank(), axis.ticks = element_blank(), 
        axis.title = element_text(size = 8), legend.text = element_text(size = 8), 
        legend.title = element_text(size = 10), 
        legend.background = element_rect(fill=alpha('white', 0.1)))

ggsave(filename = glue('{CACHE_DIR}/plot_by_sex.png'), plot = plot_by_sex, width = 2.5, height = 2.5)
plot_by_sex

```


```{r}
countByRace_Gender <- patient_race_sex_distribution

countByRace_Gender$race <- if_else(countByRace_Gender$race == 'Unknown', 'Unreported', countByRace_Gender$race)

plot_by_race  <- ggplot(countByRace_Gender %>% 
         filter(gender %in% c('Male', 'Female')) %>% 
         mutate(race = as.factor(race), n = if_else(gender == "Male", n, -n))) + 
  geom_bar(aes(x = reorder(race, -n, FUN=sum), y = n, fill = gender, group=gender), stat="identity") + 
##  scale_y_continuous(breaks = seq(-40,40, 10), labels = abs(seq(-40,40, 10))) +
  scale_fill_manual(name = "Sex", values = c(Male = "royalblue", Female = "lightcoral")) + 
  scale_y_continuous(labels = abs) +
  xlab("") + ylab("patient count") +
  coord_flip() + 
  theme_bw() + 
  theme(panel.grid = element_blank(), legend.position = "right", 
        axis.title = element_text(size = 8), axis.text = element_text(size = 8), 
        legend.text = element_text(size = 8), legend.title = element_text(size = 10), 
        legend.background = element_rect(fill=alpha('white', 0.1)))

ggsave(filename = glue("{CACHE_DIR}/plotByRace.png"), plot = plot_by_race, width = 5, height = 2)
plot_by_race
```

Patient age analysis: find the birth years for all the patients and find their current age
```{r}
get_patient_birth_year_distribution <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/patient_count_by_birth_year_sex.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
            with person_birth_year as (
            	select medical_record_number , date_of_birth , gender , date_part('Year', date_of_birth) as birth_year 
            	from hai_az_prod.person_msdw_2020july pmj
            )
            select birth_year, gender, count(*) as n 
            from person_birth_year 
            group by birth_year , gender 
            order by birth_year, gender;
            ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
  
}

patient_birth_year_sex_distribution <- get_patient_birth_year_distribution()

# lump together sex that can be treated as Unknown
patient_birth_year_sex_distribution <- patient_birth_year_sex_distribution %>% 
  mutate(gender = recode(gender, 'MSDW_NOT APPL' = 'Unknown')) %>%
  mutate(gender = recode(gender, 'MSDW_OTHER' = 'Unknown')) %>%
  mutate(gender = recode(gender, 'MSDW_UNKNOWN' = 'Unknown')) %>%
  mutate(gender = recode(gender, 'NOT AVAILABLE'= 'Unknown')) %>%
  mutate(gender = recode(gender, .missing = 'Unknown')) %>%
  # sample_n(50) %>%
  # ignore ~ 1 million patients whoes birth_year is unknown
  # filter(!is.na(birth_year)) %>%
  # 2 patients have birth_year after 2020, which is clearly error as our database cut off is 2020
  filter(birth_year <= 2020) %>%
  mutate(birth_year_bucket = cut(birth_year, breaks = c(1800, seq(1931, 2021, by = 10)), dig.lab = 4)) %>%
  group_by(birth_year_bucket, gender) %>% 
  summarise(n = sum(n)) %>% 
  arrange(birth_year_bucket)


plot_by_birth_year_sex <- patient_birth_year_sex_distribution %>% ungroup() %>% 
  filter(gender %in% c('Male', 'Female')) %>% 
  mutate(n = if_else(gender == 'Female', -n, n)) %>%
  mutate(birth_year_bucket = factor(birth_year_bucket, levels = rev(levels(birth_year_bucket)))) %>% 
  # change bucket name (1800,1931] to '<= 1931'
  # change bucket name (2011, 2021] to '(2011, 2020]' -- our database cutoff is 2020
  mutate(birth_year_bucket = recode(birth_year_bucket, '(1800,1931]' = '<=1931')) %>% 
  mutate(birth_year_bucket = recode(birth_year_bucket, '(2011,2021]' = '(2011,2020]')) %>%{
    ggplot(.) +
  geom_bar(aes(x = birth_year_bucket, y = n, fill = gender), stat = 'identity') + 
  scale_fill_manual(name = "Sex", values = c(Male = "royalblue", Female = "lightcoral")) + 
  scale_y_continuous(labels = abs) +
  xlab('') + ylab('patient count') +
  coord_flip() + 
      theme_bw() + 
  theme(panel.grid = element_blank(), legend.position = "right", 
        axis.title = element_text(size = 8), axis.text = element_text(size = 8), 
        legend.text = element_text(size = 8), legend.title = element_text(size = 10), 
        legend.background = element_rect(fill=alpha('white', 0.1)))
  }
  

ggsave(filename = glue("{CACHE_DIR}/plotByBirthyearSex.png"), plot = plot_by_birth_year_sex, width = 4, height = 3)
plot_by_birth_year_sex
  
```


### Count patient distribution by the number of HPO terms per patient 
```{r}

```


### Collect patient counts for those with lab data at each year

```{r}
get_tested_patient_count_by_year <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_patient_count_by_year.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
            with scc_lab as (
            	select medical_record_number , calendar_date as lab_date, date_part('Year', lab_date) as lab_year
            	from hai_az_prod.lab_scc_2020july lsj
            ), 
            epic_lab as (
            	select mrn as medical_record_number, order_date as lab_date, date_part('Year', lab_date) as lab_year
            	from hai_az_test.lab_epic_2020july lej
            ),
            scc_and_epic as (
            	select * 
            	from scc_lab 
            	union all
            	select * 
            	from epic_lab
            )
            select lab_year, count(distinct medical_record_number) as n_patient
            from scc_and_epic 
            group by lab_year
            order by lab_year;
            ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

tested_patient_count_by_year <- get_tested_patient_count_by_year()
```


### Analyze changes of observed phenotypes
We will used the persisted lab test table for this analysis. 
```{r}
get_phenotype_rank_all_by_year <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/observed_phenotype_rank_all_by_year.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
      with abnormal_lab as 
      	(select * from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab where hpotermid is not null and not isnegated),
      abnormal_lab_after_infer as 
      	(SELECT l.medical_record_number, l.lab_date, date_part(year, lab_date) as lab_year, l.local_test_code, l.loinc, l.hpotermid, l.isnegated, pair.ancestor , pair.distance
      	FROM abnormal_lab l 
      	left join hai_az_prod.hpo_is_a_pairs pair on l.hpotermid = pair.current),
      lab_freq_by_year as (
      	select ancestor as termid, lab_year, count(*) as n_record, count(distinct medical_record_number) as n_patient from abnormal_lab_after_infer group by ancestor, lab_year
      )
      select *
      from lab_freq_by_year
      join hai_az_prod.hpo h using (termid)
      order by lab_year, distancetoroot;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

phenotype_rank_all_by_year <- get_phenotype_rank_all_by_year()
```


```{r}
plot_phenotypes_of_interest_by_year <- function(terms_of_interest, df, normalize=TRUE){
  hpo_terms_selected <- df %>% filter(termid %in% terms_of_interest) %>% select(termid, label) %>% distinct()
  
  y_str = ifelse(normalize, 'n_patient/n_tested', 'n_patient')
  y_label = ifelse(normalize, 'patient fraction among tested', 'patient count')

  p <- df %>% filter(termid %in% terms_of_interest) %>% 
    filter(lab_year <= 2019 & lab_year > 2000) %>%
    ggplot(aes(x = lab_year, y = eval(parse(text=y_str)), group = termid, color = termid)) + 
    geom_point() +
    geom_line() +
    scale_color_discrete(breaks = hpo_terms_selected$termid, labels = str_c(hpo_terms_selected$termid, hpo_terms_selected$label, sep = " ")) +
    ylab(y_label)
  
  return (p)
}

hpo_level_1_terms <- phenotype_rank_all_by_year %>% filter(distancetoroot == 1) %>% select(termid, label) %>% distinct()
plot_phenotypes_of_interest_by_year(terms_of_interest = hpo_level_1_terms$termid, df=phenotype_rank_all_by_year, normalize = FALSE)
```

```{r}
hpo_level_1_terms <- phenotype_rank_all_by_year %>% filter(distancetoroot == 1) %>% select(termid, label) %>% distinct()
plot_phenotypes_of_interest_by_year(terms_of_interest = hpo_level_1_terms$termid, df= phenotype_rank_all_by_year %>% left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year'), normalize = TRUE)
```



### Analyze the tested phenotypes 

Whether a lab test is ordered or not can sometimes be very informative. In this section, we will analyze the most tested phenotypes.

Some phenotypes can be directly tested, such as "Increased LDL cholesterol concentration". Other phenotypes can be inferred from directly testable phenotypes, such as "Abnormal Leukocyte count", which are inferred from specific tests on different blood cell counts. We collect the count of phenotypes directly tested, or including indirectly tested ones as well.

```{r}
get_tested_phenotype_rank_direct <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_direct.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
      with testable_phenotypes_direct as (
    	select lab.medical_record_number , lab.context_name , lab.lab_date , lab.lab_time , lab.loinc , testable.termid , testable.is_tested_directly 
    	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
    	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
    	where testable.is_tested_directly 
    ),
    testable_phenotype_direct_freq as (
    	select termid, count(*) as n_record, count(distinct medical_record_number) as n_patient
    	from testable_phenotypes_direct
    	group by termid 
    )
    select testable.*, hpo.label
    from testable_phenotype_direct_freq testable
    join hai_az_prod.hpo hpo on testable.termid = hpo.termid
    order by n_record desc;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

get_tested_phenotype_rank_all <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_all.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
               with testable_phenotypes_all as (
              	select lab.medical_record_number , lab.context_name , lab.lab_date , lab.lab_time , lab.loinc , testable.termid , testable.is_tested_directly 
              	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
              	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
              	--where testable.is_tested_directly 
              ),
              testable_phenotype_all_freq as (
              	select termid, count(*) as n_record, count(distinct medical_record_number) as n_patient
              	from testable_phenotypes_all
              	group by termid 
              )
              select testable.*, hpo.label, hpo.distancetoroot 
              from testable_phenotype_all_freq testable
              join hai_az_prod.hpo hpo on testable.termid = hpo.termid
              order by n_record desc;
              ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

tested_phenotype_rank_direct <- get_tested_phenotype_rank_direct()
tested_phenotype_rank_all <- get_tested_phenotype_rank_all()
```


For the directly tested phenotypes, we can observe what are the most tested abnormalities in one healthcare system. 
```{r}
tested_phenotype_rank_direct %>% head(10) %>% formattable::formattable()
```


For the directly/indirectly tested phenotypes, we can determine at the higher level, what are the most tested abnormalities. 
```{r max.output=-1}
tested_phenotype_rank_all %>% filter(distancetoroot == 1) %>% arrange(-n_record) %>% select(-distancetoroot)
```

For both cases, it would be interesting to learn about the changes of the lab phenotypes over time, and among different races.

```{r}
get_tested_phenotype_rank_direct_by_race <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_direct_by_race.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
              with testable_phenotypes_direct as (
            	select lab.medical_record_number , person.race, lab.context_name , lab.lab_date , lab.lab_time , lab.loinc , testable.termid , testable.is_tested_directly 
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
            	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
            	join hai_az_prod.person_msdw_2020july person using (medical_record_number)
            	where testable.is_tested_directly 
            ),
            testable_phenotype_direct_freq as (
            	select termid, race, count(*) as n_record, count(distinct medical_record_number) as n_patient
            	from testable_phenotypes_direct
            	group by termid, race
            )
            select testable.*, hpo.label
            from testable_phenotype_direct_freq testable
            join hai_az_prod.hpo hpo on testable.termid = hpo.termid
            order by termid, race;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

get_tested_phenotype_rank_all_by_race <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_all_by_race.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <-  dbGetQuery(dsca, "
              with testable_phenotypes_direct as (
              	select lab.medical_record_number , person.race, lab.context_name , lab.lab_date , lab.lab_time , lab.loinc , testable.termid , testable.is_tested_directly 
              	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
              	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
              	join hai_az_prod.person_msdw_2020july person using (medical_record_number)
              	--where testable.is_tested_directly 
              ),
              testable_phenotype_direct_freq as (
              	select termid, race, count(*) as n_record, count(distinct medical_record_number) as n_patient
              	from testable_phenotypes_direct
              	group by termid, race
              )
              select testable.*, hpo.label, hpo.distancetoroot
              from testable_phenotype_direct_freq testable
              join hai_az_prod.hpo hpo on testable.termid = hpo.termid
              order by termid, race;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

tested_phenotype_rank_direct_by_race <- get_tested_phenotype_rank_direct_by_race()
tested_phenotype_rank_all_by_race <- get_tested_phenotype_rank_all_by_race()
```

For each directly measured phenotype, we can determine whether race and the tests are correlated by some form of Chi-squared teste.
```{r}
tested_phenotype_rank_direct_by_race %>% filter(race == 'African American') %>% arrange(-n_record) %>% head(10) %>% formattable::formattable()
tested_phenotype_rank_direct_by_race %>% filter(race == 'Asian') %>% arrange(-n_record) %>% head(10) %>% formattable::formattable()
tested_phenotype_rank_direct_by_race %>% filter(race == 'White') %>% arrange(-n_record) %>% head(10) %>% formattable::formattable()
```

```{r}
tested_phenotype_rank_all_by_race %>% filter(race == 'African American' & distancetoroot == 1) %>% arrange(-n_record) %>% head(10) %>% formattable::formattable()
tested_phenotype_rank_all_by_race %>% filter(race == 'Asian' & distancetoroot == 1) %>% arrange(-n_record) %>% head(10) %>% formattable::formattable()
tested_phenotype_rank_all_by_race %>% filter(race == 'White' & distancetoroot == 1) %>% arrange(-n_record) %>% head(10) %>% formattable::formattable()
```

Plot the annual change of tested phenotypes. 

```{r}
get_tested_phenotype_rank_all_by_year <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_all_by_year.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <-  dbGetQuery(dsca, "
              with testable_phenotypes_direct as (
              	select lab.medical_record_number , person.race, lab.context_name , lab.lab_date , lab.lab_time , date_part(year, lab_date) as lab_year, lab.loinc , testable.termid , testable.is_tested_directly 
              	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
              	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
              	join hai_az_prod.person_msdw_2020july person using (medical_record_number)
              	--where testable.is_tested_directly 
              ),
              testable_phenotype_direct_freq as (
              	select termid, lab_year, count(*) as n_record, count(distinct medical_record_number) as n_patient
              	from testable_phenotypes_direct
              	group by termid, lab_year
              )
              select testable.*, hpo.label, hpo.distancetoroot 
              from testable_phenotype_direct_freq testable
              join hai_az_prod.hpo hpo on testable.termid = hpo.termid
              order by termid, lab_year;
              ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

tested_phenotype_rank_all_by_year <- get_tested_phenotype_rank_all_by_year()
```

```{r}
hpo_level_1_terms <- tested_phenotype_rank_all_by_year %>% filter(distancetoroot == 1) %>% select(termid, label) %>% distinct()
plot_phenotypes_of_interest_by_year(terms_of_interest = hpo_level_1_terms$termid, df=tested_phenotype_rank_all_by_year, normalize = FALSE)
```
```{r}
plot_phenotypes_of_interest_by_year(terms_of_interest = hpo_level_1_terms$termid, df=tested_phenotype_rank_all_by_year %>% left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year'), normalize = TRUE)
```



Some trends are pretty interesting, such as the spike of Abnormal cellular phenotype. The term has three children, but only one is tested: HP:0011017 Abnormal cellular physiology

```{r}
children_abnormal_cellular_physiology <- c('HP:0003220', 'HP:0011018', 'HP:0025463', 'HP:0011019', 'HP:0003254', 'HP:4000056', 'HP:0011133', 'HP:0004371', 'HP:0031377', 'HP:0031409', 'HP:0012103', 'HP:0032576', 'HP:0003204', 'HP:0004356', 'HP:0032571', 'HP:0002916', 'HP:0003224', 'HP:0003575', 'HP:0003358')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_abnormal_cellular_physiology, df=tested_phenotype_rank_all_by_year)
```

Again, the above plot shows that it is driven by one HP:0031409 Abnormal lymphocyte physiology. 
```{r}
children_of_interest <- c('HP:0011840', 'HP:0030886', 'HP:0012177', 'HP:0005372', 'HP:0031378')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_of_interest, df=tested_phenotype_rank_all_by_year)
```
```{r}
children_of_interest <- c('HP:0002847', 'HP:0002959', 'HP:0005384', 'HP:0041076', 'HP:0010701')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_of_interest, df=tested_phenotype_rank_all_by_year)
```


```{r}
children_of_interest <- c('HP:0010702', 'HP:0032336', 'HP:0410241', 'HP:0410240', 'HP:0410243', 'HP:0410242', 'HP:0410244', 'HP:0004313')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_of_interest, df=tested_phenotype_rank_all_by_year)
```

Find what local lab codes are mapped to HP:0010702 Increased circulating antibody level and find which are tested more often after 2017.
```{r}
get_tested_phenotype_spike_by_loinc_year <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_spike_by_loinc_year.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <-  dbGetQuery(dsca, "
              with lab_spike as (
            	select context_name , lab.loinc , ltp.termid , date_part('Year', lab_date) as lab_year, count(*) as n_record, count(distinct medical_record_number) as n_patient
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab 
            	join hai_az_prod.loinc_testable_phenotypes ltp on lab.loinc = ltp.loincid 
            	where ltp.termid = 'HP:0010702'
            	group by context_name , lab.loinc , ltp.termid, date_part('Year', lab_date)
            )
            select l.*
            from lab_spike l
            order by context_name , loinc , lab_year;
              ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}


get_tested_phenotype_spike_by_localcode_year <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_spike_by_localcode_year.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <-  dbGetQuery(dsca, "
              with lab_spike as (
            	select context_name , local_test_code , ltp.termid, date_part('Year', lab_date) as lab_year, count(*) as n_record, count(distinct medical_record_number) as n_patient
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab 
            	join hai_az_prod.loinc_testable_phenotypes ltp on lab.loinc = ltp.loincid 
            	where ltp.termid = 'HP:0010702'
            	group by context_name , local_test_code ,ltp.termid,  date_part('Year', lab_date)
            ),
            local_lab_names as (
            	select distinct source, code, test_name
            	from hai_az_prod.loinc_mapping lm 
            )
            select l.*, r.test_name
            from lab_spike l
            join local_lab_names r on l.local_test_code = r.code
            order by context_name , local_test_code , lab_year;
              ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}


tested_phenotype_spike_by_loinc_year <- get_tested_phenotype_spike_by_loinc_year()
tested_phenotype_spike_by_localcode_year <- get_tested_phenotype_spike_by_localcode_year()
```

We can see the spike is caused by LOINC:10834-0 Globulin [Mass/volume] in Serum by calculation. 

The SCC spike is for LOINC:2465-3 IgG [Mass/volume] in Serum or Plasma. The increase is significant, but the raw count is still negligible. 
```{r}
tested_phenotype_spike_by_loinc_year %>% 
  left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year') %>%
    filter(lab_year <= 2019 & lab_year > 2000) %>%
  #filter(loinc == '10834-0') %>%
    ggplot(aes(x = lab_year, y = n_patient/n_tested, group = loinc, color = loinc)) + 
    geom_point() +
    geom_line() +
    #scale_color_discrete(breaks = loinc, labels = str_c('LOINC', loinc, sep = ":")) +
    ylab('patient fraction among tested') +
  facet_wrap(~context_name, nrow = 2, scales = 'free_y')
```

Similarly, if we use local codes for the plot, we can also see that EPIC lab test 3277 caused the spike, which has a name of "GLOBULIN". 
```{r}
tested_phenotype_spike_by_localcode_year %>% 
  left_join(tested_patient_count_by_year %>% rename(n_tested = n_patient), by = 'lab_year') %>%
    filter(lab_year <= 2019 & lab_year > 2000) %>%
  group_by(context_name, local_test_code) %>%
  mutate(min_year = min(lab_year), max_year = max(lab_year), max_min_year = max_year - min_year) %>%
  filter(max_min_year > 2) %>%
    ggplot(aes(x = lab_year, y = n_patient/n_tested, group = local_test_code, color = local_test_code)) + 
    geom_point() +
    geom_line() +
    #scale_color_discrete(breaks = loinc, labels = str_c('LOINC', loinc, sep = ":")) +
    ylab('patient fraction among tested') +
  theme(legend.position = 'bottom') +
  facet_wrap(~context_name, nrow = 2, scales = 'free_y')
```


