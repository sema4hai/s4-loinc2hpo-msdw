---
title: "LOINC2HPO_EPIC AND SCC"
output:
  html_document:
    df_print: paged
---

## GOAL
This is to LOINC2HPO analysis of both EPIC and SCC labs. 
```{r message=FALSE}
library(tidyverse)
library(glue)
library(readxl)
require(DBI)
require(RPostgres)
require(egg)
require(gridExtra)
source('.db_credential.R')
dsca <- DBI::dbConnect(RPostgres::Postgres(), host='localhost', user=user, dbname = dbname, port = 2345, password=password)
```


## ANALYSIS

```{r}
CACHE_DIR = 'cache'
if (!dir.exists(CACHE_DIR)){
  dir.create(CACHE_DIR)
}

get_db_data <- function(sql, df_path, force_rerun=FALSE, cache_dir=CACHE_DIR){
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, sql)
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}
```


### Analyze changes of observed phenotypes
We will used the persisted lab test table for this analysis. 
```{r}
get_phenotype_rank_all_by_year <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/observed_phenotype_rank_all_by_year.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
      with abnormal_lab as 
      	(select * from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab where hpotermid is not null and not isnegated),
      abnormal_lab_after_infer as 
      	(SELECT l.medical_record_number, l.lab_date, date_part(year, lab_date) as lab_year, l.local_test_code, l.loinc, l.hpotermid, l.isnegated, pair.ancestor , pair.distance
      	FROM abnormal_lab l 
      	left join hai_az_prod.hpo_is_a_pairs pair on l.hpotermid = pair.current),
      lab_freq_by_year as (
      	select ancestor as termid, lab_year, count(*) as n_record, count(distinct medical_record_number) as n_patient from abnormal_lab_after_infer group by ancestor, lab_year
      )
      select *
      from lab_freq_by_year
      join hai_az_prod.hpo h using (termid)
      order by lab_year, distancetoroot;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

phenotype_rank_all_by_year <- get_phenotype_rank_all_by_year()
```


```{r}
plot_phenotypes_of_interest_by_year <- function(terms_of_interest, df){
  hpo_terms_selected <- df %>% filter(termid %in% terms_of_interest) %>% select(termid, label) %>% distinct()

  p <- df %>% filter(termid %in% terms_of_interest) %>% 
    filter(lab_year <= 2019 & lab_year > 2000) %>%
    ggplot(aes(x = lab_year, y = n_patient, group = termid, color = termid)) + 
    geom_point() +
    geom_line() +
    scale_color_discrete(breaks = hpo_terms_selected$termid, labels = str_c(hpo_terms_selected$termid, hpo_terms_selected$label, sep = " "))
  
  return (p)
}

hpo_level_1_terms <- phenotype_rank_all_by_year %>% filter(distancetoroot == 1) %>% select(termid, label) %>% distinct()
plot_phenotypes_of_interest_by_year(terms_of_interest = hpo_level_1_terms$termid, df=phenotype_rank_all_by_year)
```



### Analyze the tested phenotypes 

Whether a lab test is ordered or not can sometimes be very informative. In this section, we will analyze the most tested phenotypes.

Some phenotypes can be directly tested, such as "Increased LDL cholesterol concentration". Other phenotypes can be inferred from directly testable phenotypes, such as "Abnormal Leukocyte count", which are inferred from specific tests on different blood cell counts. We collect the count of phenotypes directly tested, or including indirectly tested ones as well.

```{r}
get_tested_phenotype_rank_direct <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_direct.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
      with testable_phenotypes_direct as (
    	select lab.medical_record_number , lab.context_name , lab.lab_date , lab.lab_time , lab.loinc , testable.termid , testable.is_tested_directly 
    	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
    	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
    	where testable.is_tested_directly 
    ),
    testable_phenotype_direct_freq as (
    	select termid, count(*) as n_record, count(distinct medical_record_number) as n_patient
    	from testable_phenotypes_direct
    	group by termid 
    )
    select testable.*, hpo.label
    from testable_phenotype_direct_freq testable
    join hai_az_prod.hpo hpo on testable.termid = hpo.termid
    order by n_record desc;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

get_tested_phenotype_rank_all <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_all.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
               with testable_phenotypes_direct as (
              	select lab.medical_record_number , lab.context_name , lab.lab_date , lab.lab_time , lab.loinc , testable.termid , testable.is_tested_directly 
              	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
              	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
              	--where testable.is_tested_directly 
              ),
              testable_phenotype_direct_freq as (
              	select termid, count(*) as n_record, count(distinct medical_record_number) as n_patient
              	from testable_phenotypes_direct
              	group by termid 
              )
              select testable.*, hpo.label, hpo.distancetoroot 
              from testable_phenotype_direct_freq testable
              join hai_az_prod.hpo hpo on testable.termid = hpo.termid
              order by n_record desc;
              ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

tested_phenotype_rank_direct <- get_tested_phenotype_rank_direct()
tested_phenotype_rank_all <- get_tested_phenotype_rank_all()
```


For the directly tested phenotypes, we can observe what are the most tested abnormalities in one healthcare system. 
```{r}
tested_phenotype_rank_direct %>% head(10) %>% formattable::formattable()
```


For the directly/indirectly tested phenotypes, we can determine at the higher level, what are the most tested abnormalities. 
```{r max.output=-1}
tested_phenotype_rank_all %>% filter(distancetoroot == 1) %>% arrange(-n_record) %>% select(-distancetoroot)
```

For both cases, it would be interesting to learn about the changes of the lab phenotypes over time, and among different races.

```{r}
get_tested_phenotype_rank_direct_by_race <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_direct_by_race.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <- dbGetQuery(dsca, "
              with testable_phenotypes_direct as (
            	select lab.medical_record_number , person.race, lab.context_name , lab.lab_date , lab.lab_time , lab.loinc , testable.termid , testable.is_tested_directly 
            	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
            	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
            	join hai_az_prod.person_msdw_2020july person using (medical_record_number)
            	where testable.is_tested_directly 
            ),
            testable_phenotype_direct_freq as (
            	select termid, race, count(*) as n_record, count(distinct medical_record_number) as n_patient
            	from testable_phenotypes_direct
            	group by termid, race
            )
            select testable.*, hpo.label
            from testable_phenotype_direct_freq testable
            join hai_az_prod.hpo hpo on testable.termid = hpo.termid
            order by termid, race;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

get_tested_phenotype_rank_all_by_race <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_all_by_race.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <-  dbGetQuery(dsca, "
              with testable_phenotypes_direct as (
              	select lab.medical_record_number , person.race, lab.context_name , lab.lab_date , lab.lab_time , lab.loinc , testable.termid , testable.is_tested_directly 
              	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
              	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
              	join hai_az_prod.person_msdw_2020july person using (medical_record_number)
              	--where testable.is_tested_directly 
              ),
              testable_phenotype_direct_freq as (
              	select termid, race, count(*) as n_record, count(distinct medical_record_number) as n_patient
              	from testable_phenotypes_direct
              	group by termid, race
              )
              select testable.*, hpo.label, hpo.distancetoroot
              from testable_phenotype_direct_freq testable
              join hai_az_prod.hpo hpo on testable.termid = hpo.termid
              order by termid, race;")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

tested_phenotype_rank_direct_by_race <- get_tested_phenotype_rank_direct_by_race()
tested_phenotype_rank_all_by_race <- get_tested_phenotype_rank_all_by_race()
```

For each directly measured phenotype, we can determine whether race and the tests are correlated by some form of Chi-squared teste.
```{r}
tested_phenotype_rank_direct_by_race %>% filter(race == 'African American') %>% arrange(-n_record) %>% head(10) %>% formattable::formattable()
tested_phenotype_rank_direct_by_race %>% filter(race == 'Asian') %>% arrange(-n_record) %>% head(10) %>% formattable::formattable()
tested_phenotype_rank_direct_by_race %>% filter(race == 'White') %>% arrange(-n_record) %>% head(10) %>% formattable::formattable()
```

```{r}
tested_phenotype_rank_all_by_race %>% filter(race == 'African American' & distancetoroot == 1) %>% arrange(-n_record) %>% head(10) %>% formattable::formattable()
tested_phenotype_rank_all_by_race %>% filter(race == 'Asian' & distancetoroot == 1) %>% arrange(-n_record) %>% head(10) %>% formattable::formattable()
tested_phenotype_rank_all_by_race %>% filter(race == 'White' & distancetoroot == 1) %>% arrange(-n_record) %>% head(10) %>% formattable::formattable()
```

Plot the anual change of tested phenotypes. 

```{r}
get_tested_phenotype_rank_all_by_year <- function(force_rerun=FALSE, cache_dir=CACHE_DIR){
  df_path = glue('{cache_dir}/tested_phenotype_rank_all_by_year.csv')
  
  if (force_rerun | !file.exists(df_path)){
    df <-  dbGetQuery(dsca, "
              with testable_phenotypes_direct as (
              	select lab.medical_record_number , person.race, lab.context_name , lab.lab_date , lab.lab_time , date_part(year, lab_date) as lab_year, lab.loinc , testable.termid , testable.is_tested_directly 
              	from hai_az_prod.scc_and_epic_lab_after_loinc2hpo_2020july lab
              	join hai_az_prod.loinc_testable_phenotypes testable on lab.loinc = testable.loincid 
              	join hai_az_prod.person_msdw_2020july person using (medical_record_number)
              	--where testable.is_tested_directly 
              ),
              testable_phenotype_direct_freq as (
              	select termid, lab_year, count(*) as n_record, count(distinct medical_record_number) as n_patient
              	from testable_phenotypes_direct
              	group by termid, lab_year
              )
              select testable.*, hpo.label, hpo.distancetoroot 
              from testable_phenotype_direct_freq testable
              join hai_az_prod.hpo hpo on testable.termid = hpo.termid
              order by termid, lab_year;
              ")
    
    write.csv(df, file = df_path, row.names=FALSE)
  }
  
  df <- read.csv(df_path)
  
  return (df)
}

tested_phenotype_rank_all_by_year <- get_tested_phenotype_rank_all_by_year()
```

```{r}
hpo_level_1_terms <- tested_phenotype_rank_all_by_year %>% filter(distancetoroot == 1) %>% select(termid, label) %>% distinct()
plot_phenotypes_of_interest_by_year(terms_of_interest = hpo_level_1_terms$termid, df=tested_phenotype_rank_all_by_year)
```

Some trends are pretty interesting, such as the spike of Abnormal cellular phenotype. The term has three children, but only one is tested: HP:0011017 Abnormal cellular physiology

```{r}
children_abnormal_cellular_physiology <- c('HP:0003220', 'HP:0011018', 'HP:0025463', 'HP:0011019', 'HP:0003254', 'HP:4000056', 'HP:0011133', 'HP:0004371', 'HP:0031377', 'HP:0031409', 'HP:0012103', 'HP:0032576', 'HP:0003204', 'HP:0004356', 'HP:0032571', 'HP:0002916', 'HP:0003224', 'HP:0003575', 'HP:0003358')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_abnormal_cellular_physiology, df=tested_phenotype_rank_all_by_year)
```

Again, the above plot shows that it is driven by one HP:0031409 Abnormal lymphocyte physiology. 
```{r}
children_of_interest <- c('HP:0011840', 'HP:0030886', 'HP:0012177', 'HP:0005372', 'HP:0031378')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_of_interest, df=tested_phenotype_rank_all_by_year)
```
```{r}
children_of_interest <- c('HP:0002847', 'HP:0002959', 'HP:0005384', 'HP:0041076', 'HP:0010701')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_of_interest, df=tested_phenotype_rank_all_by_year)
```


```{r}
children_of_interest <- c('HP:0010702', 'HP:0032336', 'HP:0410241', 'HP:0410240', 'HP:0410243', 'HP:0410242', 'HP:0410244', 'HP:0004313')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_of_interest, df=tested_phenotype_rank_all_by_year)
```

```{r}
children_of_interest <- c('HP:0410367', 'HP:0031047', 'HP:0003237', 'HP:0003212', 'HP:0003261', 'HP:0410369', 'HP:0410371', 'HP:0410246', 'HP:0003496')
plot_phenotypes_of_interest_by_year(terms_of_interest = children_of_interest, df=tested_phenotype_rank_all_by_year)
```


